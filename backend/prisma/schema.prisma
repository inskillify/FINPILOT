// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  password              String
  name                  String?
  phone                 String?
  profileImage          String?
  riskProfile           String      @default("moderate") // low, moderate, high
  notificationsEnabled  Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  transactions          Transaction[]
  jars                  Jar[]
  goals                 Goal[]
  assets                Asset[]
  alerts                Alert[]
  aiInsights            AIInsight[]
  chatMessages          ChatMessage[]
  smsRecords            SMSRecord[]
  portfolios            Portfolio[]

  @@map("users")
}

// Transaction Model
model Transaction {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?
  amount            Decimal     @db.Decimal(12, 2)
  category          String      // Food, Transport, Entertainment, Utilities, etc.
  type              String      // income, expense, transfer
  paymentMethod     String?     // cash, card, upi, bank_transfer
  
  date              DateTime
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  jarId             String?
  jar               Jar?        @relation(fields: [jarId], references: [id], onDelete: SetNull)
  
  goalId            String?
  goal              Goal?       @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([date])
  @@index([category])
  @@map("transactions")
}

// Jar Model (Savings Buckets)
model Jar {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name              String
  description       String?
  targetAmount      Decimal     @db.Decimal(12, 2)
  currentAmount     Decimal     @db.Decimal(12, 2) @default(0)
  color             String      @default("#3B82F6")
  icon              String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  transactions      Transaction[]

  @@index([userId])
  @@map("jars")
}

// Goal Model
model Goal {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?
  targetAmount      Decimal     @db.Decimal(12, 2)
  currentAmount     Decimal     @db.Decimal(12, 2) @default(0)
  category          String      // vacation, education, home, car, etc.
  priority          String      @default("medium") // low, medium, high
  
  startDate         DateTime
  targetDate        DateTime
  status            String      @default("active") // active, completed, paused
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  transactions      Transaction[]

  @@index([userId])
  @@index([status])
  @@map("goals")
}

// Asset Model (Portfolio Tracking)
model Asset {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name              String
  symbol            String
  type              String      // stock, crypto, mutual_fund, bond, etc.
  quantity          Decimal     @db.Decimal(18, 8)
  buyPrice          Decimal     @db.Decimal(12, 2)
  currentPrice      Decimal     @db.Decimal(12, 2)
  
  totalValue        Decimal     @db.Decimal(12, 2)
  gainLoss          Decimal     @db.Decimal(12, 2)
  gainLossPercent   Decimal     @db.Decimal(5, 2)
  
  lastUpdated       DateTime    @default(now())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@map("assets")
}

// Portfolio Model
model Portfolio {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalValue        Decimal     @db.Decimal(12, 2)
  dailyPnL          Decimal     @db.Decimal(12, 2)
  dailyPnLPercent   Decimal     @db.Decimal(5, 2)
  
  allocationJson    String      // JSON string for allocation breakdown
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@map("portfolios")
}

// Alert Model
model Alert {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title             String
  message           String
  type              String      // critical, warning, info
  category          String      // spending, goal, jar, portfolio, etc.
  
  actionUrl         String?
  actionText        String?
  
  read              Boolean     @default(false)
  dismissed         Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@index([type])
  @@map("alerts")
}

// AI Insight Model
model AIInsight {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              String      // prediction, pattern, optimization, categorization
  title             String
  description       String
  dataJson          String      // JSON string for insight data
  
  confidence        Decimal     @db.Decimal(3, 2) @default(0.85)
  actionable        Boolean     @default(true)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@index([type])
  @@map("ai_insights")
}

// Chat Message Model
model ChatMessage {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role              String      // user, assistant
  content           String
  
  suggestedPrompts  String?     // JSON array of suggested prompts
  responseType      String?     // card, metric, actionable, text
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@map("chat_messages")
}

// SMS Record Model
model SMSRecord {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  smsText           String
  sender            String?
  
  parsedAmount      Decimal?    @db.Decimal(12, 2)
  parsedCategory    String?
  parsedType        String?     // income, expense
  
  processed         Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@map("sms_records")
}

// Spending Habit Model
model SpendingHabit {
  id                String      @id @default(cuid())
  userId            String
  
  category          String
  weeklyAverage     Decimal     @db.Decimal(12, 2)
  monthlyAverage    Decimal     @db.Decimal(12, 2)
  trend             String      // increasing, decreasing, stable
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@unique([userId, category])
  @@map("spending_habits")
}
